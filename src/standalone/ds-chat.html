<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络聊天机器人</title>
    <style>
        /* 保持之前的样式不变 */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
#chat-container {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    position: absolute;
    inset: 10px;
    display: flex;
    flex-direction: column;
}        #chat-header { background-color: #6e48aa; color: white; padding: 15px; text-align: center; font-weight: bold; }
        #chat-messages { overflow-y: auto; padding: 20px; flex: 1; }
        .message { margin-bottom: 15px; max-width: 80%; word-break: break-all; white-space: pre-wrap; font-family: Consolas, monospace, NSimsun; }
        .user-message { margin-left: auto; background-color: #6e48aa; color: white; padding: 10px 15px; border-radius: 18px 18px 0 18px; }
        .bot-message { margin-right: auto; background-color: #f1f1f1; padding: 10px 15px; border-radius: 18px 18px 18px 0; }
        #input-area { display: flex; padding: 15px; background-color: #f9f9f9; border-top: 1px solid #eee; }
        #api-key-input { width: 30px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px; }
        #message-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px; }
        button { padding: 10px 15px; background-color: #6e48aa; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #5d3a99; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .typing-indicator { display: inline-block; padding: 10px 15px; background-color: #f1f1f1; border-radius: 18px 18px 18px 0; }
        .typing-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #999; margin: 0 2px; animation: typing-animation 1.4s infinite ease-in-out; }
        @keyframes typing-animation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        #context-controls { padding: 10px 15px; background-color: #f0f0f0; display: flex; justify-content: space-between; }
        #context-token-count { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">
            网络聊天机器人
        </div>
        <div id="context-controls">
            <button id="clear-context">清空上下文</button>
            <span id="context-token-count">上下文长度: 0 tokens</span>
        </div>
        <div id="chat-messages">
            <div class="message bot-message">您好！我是DeepSeek AI助手。请先在下方输入您的API Key，然后开始聊天。</div>
        </div>
        <div id="input-area">
            <input type="password" id="api-key-input" placeholder="输入您的DeepSeek API Key">
            <input type="checkbox" id="remember-api-key" style="margin-right:10px">
            <input type="text" id="message-input" placeholder="输入消息..." disabled>
            <button id="send-button" disabled>发送</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const apiKeyInput = document.getElementById('api-key-input');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearContextBtn = document.getElementById('clear-context');
        const tokenCountSpan = document.getElementById('context-token-count');
        const rememberApiKeyCheckbox = document.getElementById('remember-api-key');
        
        // 页面加载时检查是否有保存的API Key
        const savedApiKey = localStorage.getItem('deepseek_api_key');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
            rememberApiKeyCheckbox.checked = true;
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
        
        // 对话历史记录（用于维护上下文）
        let conversationHistory = [
            { role: "system", content: "" }
        ];
        
        // 启用/禁用聊天输入
        apiKeyInput.addEventListener('input', () => {
            const hasApiKey = apiKeyInput.value.trim().length > 0;
            messageInput.disabled = !hasApiKey;
            sendButton.disabled = !hasApiKey;
            if (hasApiKey) {
                messageInput.focus();
                if (rememberApiKeyCheckbox.checked) {
                    localStorage.setItem('deepseek_api_key', apiKeyInput.value.trim());
                }
            } else {
                localStorage.removeItem('deepseek_api_key');
            }
        });
        
        rememberApiKeyCheckbox.addEventListener('change', () => {
            if (rememberApiKeyCheckbox.checked && apiKeyInput.value.trim()) {
                localStorage.setItem('deepseek_api_key', apiKeyInput.value.trim());
            } else {
                localStorage.removeItem('deepseek_api_key');
            }
        });
        
        // 发送消息
        async function sendMessage() {
            const apiKey = apiKeyInput.value.trim();
            const message = messageInput.value.trim();
            
            if (!apiKey) return alert('请先输入API Key');
            if (!message) return;
            
            // 添加用户消息到聊天界面和历史记录
            addMessage(message, 'user-message');
            conversationHistory.push({ role: "user", content: message });
            updateTokenCount();
            
            messageInput.value = '';
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            // 创建新的机器人消息容器
            const botMessageId = 'msg-' + Date.now();
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'message bot-message';
            botMessageDiv.id = botMessageId;
            chatMessages.appendChild(botMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 显示"正在输入"指示器
            showTypingIndicator();
            clearContextBtn.hidden = true;
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop();
                    
                    for (const part of parts) {
                        if (part.startsWith('data: ')) {
                            const data = part.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const jsonData = JSON.parse(data);
                                if (jsonData.choices?.[0]?.delta?.content) {
                                    const content = jsonData.choices[0].delta.content;
                                    fullResponse += content;
                                    document.getElementById(botMessageId).textContent = fullResponse;
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } catch (e) {
                                console.error('解析错误:', e);
                            }
                        }
                    }
                }
                
                // 将AI回复添加到历史记录
                if (fullResponse) {
                    conversationHistory.push({ role: "assistant", content: fullResponse });
                    updateTokenCount();
                }
                
            } catch (error) {
                console.error('请求出错:', error);
                addMessage(`请求出错: ${error.message}`, 'bot-message');
            } finally {
                hideTypingIndicator();
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
                clearContextBtn.hidden = false;
            }
        }
        
        // 清空上下文
        clearContextBtn.addEventListener('click', () => {
            conversationHistory = [
                { role: "system", content: "你是一个有帮助的AI助手，回答要简洁专业但友好。" }
            ];
            updateTokenCount();
            addMessage("上下文已重置，我们可以开始新的话题了", 'bot-message');
        });
        
        // 更新token计数显示
        function updateTokenCount() {
            // 简单估算：1个汉字≈2 tokens，1个英文单词≈1.3 tokens
            const totalChars = conversationHistory.reduce((sum, msg) => 
                sum + msg.content.length, 0);
            const estimatedTokens = Math.ceil(totalChars * 0.7);
            tokenCountSpan.textContent = `上下文长度: ~${estimatedTokens} tokens`;
        }
        
        // 添加消息到聊天界面
        function addMessage(text, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 显示/隐藏"正在输入"指示器
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function hideTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }
        
        // 事件监听
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
    </script>
</body>
</html>